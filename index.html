<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>K6 Performance Test Results - SmartRent</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            min-height: 100vh;
            padding: 20px;
            color: #fff;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        h1 {
            text-align: center;
            margin-bottom: 10px;
            font-size: 2.5rem;
            background: linear-gradient(90deg, #00d4ff, #7b2cbf);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        .subtitle {
            text-align: center;
            color: #888;
            margin-bottom: 30px;
        }
        .upload-section {
            background: rgba(255,255,255,0.1);
            border-radius: 15px;
            padding: 30px;
            text-align: center;
            margin-bottom: 30px;
            border: 2px dashed #444;
        }
        .upload-section:hover {
            border-color: #00d4ff;
        }
        .file-select-section {
            background: rgba(255,255,255,0.1);
            border-radius: 15px;
            padding: 30px;
            text-align: center;
            margin-bottom: 30px;
        }
        #fileInput {
            display: none;
        }
        .upload-btn {
            background: linear-gradient(90deg, #00d4ff, #7b2cbf);
            color: white;
            padding: 15px 40px;
            border: none;
            border-radius: 30px;
            font-size: 1.1rem;
            cursor: pointer;
            transition: transform 0.3s;
        }
        .upload-btn:hover {
            transform: scale(1.05);
        }
        .dashboard {
            display: none;
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .stat-card {
            background: rgba(0, 0, 0, 1);
            border-radius: 15px;
            padding: 25px;
            text-align: center;
            backdrop-filter: blur(10px);
            transition: transform 0.3s;
        }
        .stat-card:hover {
            transform: translateY(-5px);
        }
        .stat-card.success {
            border-left: 4px solid #00ff88;
        }
        .stat-card.warning {
            border-left: 4px solid #ffaa00;
        }
        .stat-card.error {
            border-left: 4px solid #ff4444;
        }
        .stat-card.info {
            border-left: 4px solid #00d4ff;
        }
        .stat-value {
            font-size: 2.5rem;
            font-weight: bold;
            margin-bottom: 5px;
        }
        .stat-label {
            color: #888;
            font-size: 0.9rem;
            text-transform: uppercase;
        }
        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .chart-card {
            background: rgba(255,255,255,0.1);
            border-radius: 15px;
            padding: 25px;
            backdrop-filter: blur(10px);
        }
        .chart-title {
            font-size: 1.2rem;
            margin-bottom: 20px;
            color: #00d4ff;
        }
        .api-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        .api-table th, .api-table td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        .api-table th {
            background: rgba(0,212,255,0.2);
            color: #00d4ff;
        }
        .api-table tr:hover {
            background: rgba(255,255,255,0.05);
        }
        .badge {
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: bold;
        }
        .badge-success {
            background: rgba(0,255,136,0.2);
            color: #00ff88;
        }
        .badge-warning {
            background: rgba(255,170,0,0.2);
            color: #ffaa00;
        }
        .badge-error {
            background: rgba(255,68,68,0.2);
            color: #ff4444;
        }
        .threshold-section {
            background: rgba(255,255,255,0.1);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 30px;
        }
        .threshold-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 0;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        .threshold-item:last-child {
            border-bottom: none;
        }
        .compare-section {
            background: rgba(255,255,255,0.1);
            border-radius: 15px;
            padding: 25px;
            margin-top: 30px;
            margin-bottom: 30px;
        }
        .compare-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        .compare-upload {
            border: 2px dashed #444;
            border-radius: 10px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
        }
        .compare-upload:hover {
            border-color: #7b2cbf;
        }
        .comparison-table {
            margin-top: 20px;
        }
        .diff-positive {
            color: #00ff88;
        }
        .diff-negative {
            color: #ff4444;
        }
        @media (max-width: 768px) {
            .charts-grid {
                grid-template-columns: 1fr;
            }
            .compare-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>K6 Performance Dashboard</h1>
        <p class="subtitle">SmartRent API Performance Testing Results</p>

        <div class="file-select-section">
            <h2 style="margin-bottom: 20px;">Load from Results Folder</h2>
            <select id="resultFileSelect" style="padding: 10px; margin-right: 10px; border-radius: 5px; background: #181828; color: #fff; border: 1px solid #444;">
                        <style>
                        /* ...existing code... */
                        /* Custom dropdown style for dark background */
                        select#resultFileSelect, select#resultFileSelect option {
                            background: #181828;
                            color: #fff;
                        }
                        select#resultFileSelect:focus {
                            outline: 2px solid #00d4ff;
                        }
                        </style>
                <option value="">Choose a file...</option>
            </select>
            <button class="upload-btn" onclick="loadSelectedFile()">Load File</button>
        </div>

        <div class="upload-section" id="uploadSection">
            <h2 style="margin-bottom: 20px;">Upload K6 Results JSON</h2>
            <p style="color: #888; margin-bottom: 20px;">
                Drag & drop your k6-api-test-results.json or k6-core-api-results.json file here
            </p>
            <input type="file" id="fileInput" accept=".json">
            <button class="upload-btn" onclick="document.getElementById('fileInput').click()">
                Choose File
            </button>
        </div>

        <div class="dashboard" id="dashboard">
            <!-- Overview Stats -->
            <div class="stats-grid" id="statsGrid"></div>

            <!-- Thresholds -->
            <div class="threshold-section">
                <h2 class="chart-title">Threshold Results</h2>
                <div id="thresholdResults"></div>
            </div>

            <!-- Charts -->
            <div class="charts-grid">
                <div class="chart-card">
                    <h3 class="chart-title">Response Time by API (ms)</h3>
                    <canvas id="responseTimeChart"></canvas>
                </div>
                <div class="chart-card">
                    <h3 class="chart-title">P95 vs Average Response Time</h3>
                    <canvas id="p95Chart"></canvas>
                </div>
            </div>

            <!-- API Details Table -->
            <div class="chart-card">
                <h3 class="chart-title">API Performance Details</h3>
                <table class="api-table" id="apiTable">
                    <thead>
                        <tr>
                            <th>API Endpoint</th>
                            <th>Avg (ms)</th>
                            <th>Min (ms)</th>
                            <th>Max (ms)</th>
                            <th>P90 (ms)</th>
                            <th>P95 (ms)</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody id="apiTableBody"></tbody>
                </table>
            </div>

            <!-- Compare Section -->
            <div class="compare-section">
                <h2 class="chart-title">Compare with Previous Test</h2>
                <p style="color: #888; margin-bottom: 20px;">Upload another JSON file to compare results</p>
                <input type="file" id="compareFileInput" accept=".json" style="display:none">
                <button class="upload-btn" onclick="document.getElementById('compareFileInput').click()" style="background: linear-gradient(90deg, #7b2cbf, #00d4ff);">
                    Upload Comparison File
                </button>
                <div id="comparisonResults" style="margin-top: 20px;"></div>
            </div>
        </div>
    </div>

    <script>
        let currentData = null;
        let compareData = null;
        let responseTimeChart = null;
        let p95Chart = null;

        // File upload handling
        document.getElementById('fileInput').addEventListener('change', handleFileUpload);
        document.getElementById('compareFileInput').addEventListener('change', handleCompareUpload);

        // Drag and drop
        const uploadSection = document.getElementById('uploadSection');
        uploadSection.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadSection.style.borderColor = '#00d4ff';
        });
        uploadSection.addEventListener('dragleave', () => {
            uploadSection.style.borderColor = '#444';
        });
        uploadSection.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadSection.style.borderColor = '#444';
            const file = e.dataTransfer.files[0];
            if (file && file.name.endsWith('.json')) {
                processFile(file);
            }
        });

        function handleFileUpload(e) {
            const file = e.target.files[0];
            if (file) processFile(file);
        }

        function handleCompareUpload(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (event) => {
                    compareData = JSON.parse(event.target.result);
                    showComparison();
                };
                reader.readAsText(file);
            }
        }

        function processFile(file) {
            const reader = new FileReader();
            reader.onload = (event) => {
                currentData = JSON.parse(event.target.result);
                renderDashboard();
            };
            reader.readAsText(file);
        }

        // Tải danh sách file từ results-index.json khi load trang
        document.addEventListener('DOMContentLoaded', function() {
            fetch('results/results-index.json')
                .then(response => response.json())
                .then(files => {
                    const select = document.getElementById('resultFileSelect');
                    files.filter(f => f.endsWith('.json')).forEach(file => {
                        const option = document.createElement('option');
                        option.value = 'results/' + file;
                        option.textContent = file;
                        select.appendChild(option);
                    });
                });
        });

        function loadSelectedFile() {
            const select = document.getElementById('resultFileSelect');
            const filePath = select.value;
            if (filePath) {
                fetch(filePath)
                .then(response => response.json())
                .then(data => {
                    currentData = data;
                    renderDashboard();
                })
                .catch(error => {
                    alert('Error loading file: ' + error);
                });
            }
        }

        function renderDashboard() {
            document.getElementById('uploadSection').style.display = 'none';
            document.getElementById('dashboard').style.display = 'block';

            const metrics = currentData.metrics;

            // Render stats
            renderStats(metrics);

            // Render thresholds
            renderThresholds(metrics);

            // Render charts
            renderCharts(metrics);

            // Render API table
            renderApiTable(metrics);
        }

        function renderStats(metrics) {
            const statsGrid = document.getElementById('statsGrid');
            const httpReqs = metrics.http_reqs?.values?.count || 0;
            const reqRate = metrics.http_reqs?.values?.rate?.toFixed(2) || 0;
            const avgDuration = metrics.http_req_duration?.values?.avg?.toFixed(0) || 0;
            const errorRate = ((metrics.http_req_failed?.values?.rate || 0) * 100).toFixed(2);
            const p95 = metrics.http_req_duration?.values['p(95)']?.toFixed(0) || 0;

            const errorClass = parseFloat(errorRate) < 5 ? 'success' : parseFloat(errorRate) < 10 ? 'warning' : 'error';

            statsGrid.innerHTML = `
                <div class="stat-card info">
                    <div class="stat-value">${httpReqs}</div>
                    <div class="stat-label">Total Requests</div>
                </div>
                <div class="stat-card info">
                    <div class="stat-value">${reqRate}/s</div>
                    <div class="stat-label">Request Rate</div>
                </div>
                <div class="stat-card ${avgDuration < 1000 ? 'success' : avgDuration < 2000 ? 'warning' : 'error'}">
                    <div class="stat-value">${avgDuration}ms</div>
                    <div class="stat-label">Avg Response Time</div>
                </div>
                <div class="stat-card ${p95 < 2000 ? 'success' : p95 < 5000 ? 'warning' : 'error'}">
                    <div class="stat-value">${p95}ms</div>
                    <div class="stat-label">P95 Response Time</div>
                </div>
                <div class="stat-card ${errorClass}">
                    <div class="stat-value">${errorRate}%</div>
                    <div class="stat-label">Error Rate</div>
                </div>
            `;
        }

        function renderThresholds(metrics) {
            const container = document.getElementById('thresholdResults');
            const thresholds = [
                {
                    name: 'HTTP Request Duration (p95)',
                    value: metrics.http_req_duration?.values['p(95)']?.toFixed(2) || 0,
                    target: '< 2000ms',
                    pass: (metrics.http_req_duration?.values['p(95)'] || 0) < 2000
                },
                {
                    name: 'HTTP Request Failed Rate',
                    value: ((metrics.http_req_failed?.values?.rate || 0) * 100).toFixed(2) + '%',
                    target: '< 5%',
                    pass: (metrics.http_req_failed?.values?.rate || 0) < 0.05
                },
                {
                    name: 'Custom Error Rate',
                    value: ((metrics.errors?.values?.rate || 0) * 100).toFixed(2) + '%',
                    target: '< 5%',
                    pass: (metrics.errors?.values?.rate || 0) < 0.05
                }
            ];

            container.innerHTML = thresholds.map(t => `
                <div class="threshold-item">
                    <span>${t.name}</span>
                    <span>
                        <strong>${t.value}</strong> (Target: ${t.target})
                        <span class="badge ${t.pass ? 'badge-success' : 'badge-error'}">
                            ${t.pass ? '✓ PASS' : '✗ FAIL'}
                        </span>
                    </span>
                </div>
            `).join('');
        }

        function renderCharts(metrics) {
            const apiMetrics = extractApiMetrics(metrics);

            // Response Time Chart
            const ctx1 = document.getElementById('responseTimeChart').getContext('2d');
            if (responseTimeChart) responseTimeChart.destroy();

            responseTimeChart = new Chart(ctx1, {
                type: 'bar',
                data: {
                    labels: apiMetrics.map(m => m.name),
                    datasets: [{
                        label: 'Average (ms)',
                        data: apiMetrics.map(m => m.avg),
                        backgroundColor: 'rgba(0, 212, 255, 0.7)',
                        borderColor: 'rgba(0, 212, 255, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { labels: { color: '#fff' } }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: { color: '#888' },
                            grid: { color: 'rgba(255,255,255,0.1)' }
                        },
                        x: {
                            ticks: { color: '#888' },
                            grid: { color: 'rgba(255,255,255,0.1)' }
                        }
                    }
                }
            });

            // P95 vs Avg Chart
            const ctx2 = document.getElementById('p95Chart').getContext('2d');
            if (p95Chart) p95Chart.destroy();

            p95Chart = new Chart(ctx2, {
                type: 'bar',
                data: {
                    labels: apiMetrics.map(m => m.name),
                    datasets: [
                        {
                            label: 'Average (ms)',
                            data: apiMetrics.map(m => m.avg),
                            backgroundColor: 'rgba(0, 212, 255, 0.7)',
                        },
                        {
                            label: 'P95 (ms)',
                            data: apiMetrics.map(m => m.p95),
                            backgroundColor: 'rgba(123, 44, 191, 0.7)',
                        }
                    ]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { labels: { color: '#fff' } }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: { color: '#888' },
                            grid: { color: 'rgba(255,255,255,0.1)' }
                        },
                        x: {
                            ticks: { color: '#888' },
                            grid: { color: 'rgba(255,255,255,0.1)' }
                        }
                    }
                }
            });
        }

        function extractApiMetrics(metrics) {
            const apiMetrics = [];
            const metricMappings = {
                'login_duration': 'Login API',
                'get_listings_duration': 'Get Listings',
                'search_duration': 'Search API',
                'listing_detail_duration': 'Listing Detail',
                'stats_province_duration': 'Stats Province',
                'stats_category_duration': 'Stats Category'
            };

            for (const [key, name] of Object.entries(metricMappings)) {
                if (metrics[key]) {
                    apiMetrics.push({
                        name: name,
                        avg: metrics[key].values.avg?.toFixed(0) || 0,
                        min: metrics[key].values.min?.toFixed(0) || 0,
                        max: metrics[key].values.max?.toFixed(0) || 0,
                        p90: metrics[key].values['p(90)']?.toFixed(0) || 0,
                        p95: metrics[key].values['p(95)']?.toFixed(0) || 0
                    });
                }
            }

            // Add overall HTTP duration if no custom metrics
            if (apiMetrics.length === 0 && metrics.http_req_duration) {
                apiMetrics.push({
                    name: 'All Requests',
                    avg: metrics.http_req_duration.values.avg?.toFixed(0) || 0,
                    min: metrics.http_req_duration.values.min?.toFixed(0) || 0,
                    max: metrics.http_req_duration.values.max?.toFixed(0) || 0,
                    p90: metrics.http_req_duration.values['p(90)']?.toFixed(0) || 0,
                    p95: metrics.http_req_duration.values['p(95)']?.toFixed(0) || 0
                });
            }

            return apiMetrics;
        }

        function renderApiTable(metrics) {
            const tbody = document.getElementById('apiTableBody');
            const apiMetrics = extractApiMetrics(metrics);

            tbody.innerHTML = apiMetrics.map(m => {
                const status = m.p95 < 1000 ? 'success' : m.p95 < 2000 ? 'warning' : 'error';
                const statusText = m.p95 < 1000 ? 'Fast' : m.p95 < 2000 ? 'OK' : 'Slow';

                return `
                    <tr>
                        <td><strong>${m.name}</strong></td>
                        <td>${m.avg}</td>
                        <td>${m.min}</td>
                        <td>${m.max}</td>
                        <td>${m.p90}</td>
                        <td>${m.p95}</td>
                        <td><span class="badge badge-${status}">${statusText}</span></td>
                    </tr>
                `;
            }).join('');
        }

        function showComparison() {
            if (!currentData || !compareData) return;

            const container = document.getElementById('comparisonResults');
            const current = extractApiMetrics(currentData.metrics);
            const previous = extractApiMetrics(compareData.metrics);

            let html = `
                <table class="api-table comparison-table">
                    <thead>
                        <tr>
                            <th>API</th>
                            <th>Current Avg</th>
                            <th>Previous Avg</th>
                            <th>Difference</th>
                            <th>Current P95</th>
                            <th>Previous P95</th>
                            <th>Difference</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            current.forEach(c => {
                const p = previous.find(x => x.name === c.name);
                if (p) {
                    const avgDiff = c.avg - p.avg;
                    const p95Diff = c.p95 - p.p95;
                    const avgClass = avgDiff < 0 ? 'diff-positive' : avgDiff > 0 ? 'diff-negative' : '';
                    const p95Class = p95Diff < 0 ? 'diff-positive' : p95Diff > 0 ? 'diff-negative' : '';

                    html += `
                        <tr>
                            <td><strong>${c.name}</strong></td>
                            <td>${c.avg}ms</td>
                            <td>${p.avg}ms</td>
                            <td class="${avgClass}">${avgDiff > 0 ? '+' : ''}${avgDiff}ms</td>
                            <td>${c.p95}ms</td>
                            <td>${p.p95}ms</td>
                            <td class="${p95Class}">${p95Diff > 0 ? '+' : ''}${p95Diff}ms</td>
                        </tr>
                    `;
                }
            });

            html += '</tbody></table>';
            container.innerHTML = html;
        }
    </script>
</body>
</html>
